# IPTV Streaming Application Reverse Proxy Configuration
# Place this file at: /mnt/user/appdata/swag/nginx/proxy-confs/iptv.subdomain.conf
# On Unraid server: 192.168.154.196

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    server_name iptv.*;

    include /config/nginx/ssl.conf;

    client_max_body_size 0;

    # Security headers
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Frontend (React SPA) - served on port 3000
    location / {
        include /config/nginx/proxy.conf;
        include /config/nginx/resolver.conf;

        set $upstream_app 192.168.154.158;
        set $upstream_port 3000;
        set $upstream_proto http;

        proxy_pass $upstream_proto://$upstream_app:$upstream_port;

        # SPA routing - serve index.html for all non-file routes
        proxy_intercept_errors on;
        error_page 404 = @fallback;
    }

    # SPA fallback
    location @fallback {
        include /config/nginx/proxy.conf;

        set $upstream_app 192.168.154.158;
        set $upstream_port 3000;
        set $upstream_proto http;

        proxy_pass $upstream_proto://$upstream_app:$upstream_port/index.html;
    }

    # Backend API - served on port 4000
    location /api {
        include /config/nginx/proxy.conf;
        include /config/nginx/resolver.conf;

        set $upstream_app 192.168.154.158;
        set $upstream_port 4000;
        set $upstream_proto http;

        proxy_pass $upstream_proto://$upstream_app:$upstream_port;

        # Extended timeouts for API calls
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
        proxy_connect_timeout 30s;
    }

    # Streaming endpoint - special handling for long-running connections
    location /api/stream {
        include /config/nginx/proxy.conf;
        include /config/nginx/resolver.conf;

        set $upstream_app 192.168.154.158;
        set $upstream_port 4000;
        set $upstream_proto http;

        proxy_pass $upstream_proto://$upstream_app:$upstream_port;

        # Disable buffering for live streams
        proxy_buffering off;
        proxy_cache off;

        # Long timeouts for streams
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        proxy_connect_timeout 30s;

        # Chunked transfer for HLS/streaming
        chunked_transfer_encoding on;

        # Disable response size limit
        proxy_max_temp_file_size 0;

        # Additional streaming headers
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }

    # Health check endpoint (no auth required)
    location /api/health {
        include /config/nginx/proxy.conf;
        include /config/nginx/resolver.conf;

        set $upstream_app 192.168.154.158;
        set $upstream_port 4000;
        set $upstream_proto http;

        proxy_pass $upstream_proto://$upstream_app:$upstream_port;

        proxy_read_timeout 10s;
    }
}
